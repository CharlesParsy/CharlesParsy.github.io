<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Liste des questions</title>
    <link rel="icon" type="image/x-icon" href="logo.svg">
    <link rel="stylesheet" href="style2.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script type="module">
        // üîí V√©rifie la connexion admin
        if (localStorage.getItem("adminConnected") !== "true") {
            window.location.href = "login.html";
        }

        import { logout, getQuestionsByCategory, loadCategories, deleteCategory, renameCategory } from "./script.js";

        document.addEventListener("DOMContentLoaded", async () => {
            const select = document.getElementById("categorie");
            const listDiv = document.getElementById("list");
            const renameInput = document.getElementById("renameCatInput");
            const renameBtn = document.getElementById("renameCatBtn");

            // üîπ Charger les cat√©gories
            async function refreshCategories() {
                const categories = await loadCategories();
                select.innerHTML = "<option value=''>-- S√©lectionnez une cat√©gorie --</option>";
                if (categories) {
                    categories.forEach(cat => {
                        const opt = document.createElement("option");
                        opt.value = cat;
                        opt.textContent = cat.charAt(0).toUpperCase() + cat.slice(1);
                        select.appendChild(opt);
                    });
                }
            }

            await refreshCategories();

            // üîπ Afficher les questions lors de la s√©lection d‚Äôune cat√©gorie
            select.addEventListener("change", async () => {
                const cat = select.value;
                listDiv.innerHTML = "";
                if (!cat) return;

                const questions = await getQuestionsByCategory(cat);
                if (!questions || questions.length === 0) {
                    listDiv.textContent = "Aucune question trouv√©e dans cette cat√©gorie.";
                    return;
                }

                questions.forEach(q => {
                    const div = document.createElement("div");
                    div.className = "question-item";
                    div.innerHTML = `
                        <p><strong>${q.intitule}</strong></p>
                        <p><em>R√©ponse :</em> ${q.reponse}</p>
                        <button class="modifier">Modifier</button>
                        <button class="supprimer">Supprimer</button>
                        <hr>
                    `;

                    div.querySelector(".modifier").addEventListener("click", () => {
                        localStorage.setItem("editCat", cat);
                        localStorage.setItem("editId", q.id);
                        window.location.href = "modifier.html";
                    });

                    div.querySelector(".supprimer").addEventListener("click", async () => {
                        if (confirm("Supprimer cette question ?")) {
                            await deleteDoc(doc(db, cat, q.id));
                            div.remove();
                        }
                    });

                    listDiv.appendChild(div);
                });
            });

            // üîπ Supprimer la cat√©gorie
            document.getElementById("deleteCatBtn").addEventListener("click", async () => {
                const cat = select.value;
                if (!cat) return alert("Veuillez s√©lectionner une cat√©gorie √† supprimer !");
                if (!confirm(`Supprimer la cat√©gorie "${cat}" et toutes ses questions ?`)) return;

                try {
                    await deleteCategory(cat);
                    alert(`Cat√©gorie "${cat}" supprim√©e avec succ√®s !`);
                    await refreshCategories();
                    listDiv.innerHTML = "";
                } catch (e) {
                    console.error(e);
                    alert("Erreur lors de la suppression de la cat√©gorie !");
                }
            });

            // üîπ Renommer la cat√©gorie
            renameBtn.addEventListener("click", async () => {
                const oldCat = select.value;
                const newCat = renameInput.value.trim();
                if (!oldCat) return alert("Veuillez s√©lectionner une cat√©gorie √† renommer !");
                if (!newCat) return alert("Veuillez saisir le nouveau nom !");
                if (oldCat === newCat) return alert("Le nouveau nom est identique √† l'ancien !");

                if (!confirm(`Renommer la cat√©gorie "${oldCat}" en "${newCat}" ?`)) return;

                try {
                    await renameCategory(oldCat, newCat);
                    alert(`Cat√©gorie renomm√©e en "${newCat}" avec succ√®s !`);
                    await refreshCategories();
                    listDiv.innerHTML = "";
                    renameInput.value = "";
                } catch (e) {
                    console.error(e);
                    alert("Erreur lors du renommage de la cat√©gorie !");
                }
            });

            document.getElementById("logoutBtn").addEventListener("click", logout);
        });
    </script>
</head>

<body>
<a class="logoA" href="index.html"><img class="logo" src="logo.svg"></a>

<h1>Liste des questions</h1>
<a href="ajout.html">Ajouter une question ou une cat√©gorie</a>

<div>
    <label for="categorie"><strong>Cat√©gorie :</strong></label>
    <select id="categorie"></select>
    <button id="deleteCatBtn">Supprimer la cat√©gorie</button>
    <input type="text" id="renameCatInput" placeholder="Nouveau nom de cat√©gorie">
    <button id="renameCatBtn">Renommer la cat√©gorie</button>
</div>

<div id="list"></div>
<p id="message"></p>
<button id="logoutBtn">Se d√©connecter</button>
</body>
</html>
